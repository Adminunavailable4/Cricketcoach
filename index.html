<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CricCoach Mobile</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');

        body {
            margin: 0;
            background-color: #000;
            color: #00f3ff;
            font-family: 'Share Tech Mono', monospace;
            overflow: hidden; /* Prevent scrolling */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Responsive Camera Container */
        #interface-container {
            position: relative;
            width: 100vw; /* Full width of phone */
            height: 75vh; /* 75% of screen height */
            background: #111;
            overflow: hidden;
            border-bottom: 2px solid #00f3ff;
        }

        /* Force canvas to fit container */
        canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: cover;
        }

        /* HUD Overlay */
        .hud-overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            box-sizing: border-box;
            border: 1px solid rgba(0, 243, 255, 0.3);
        }

        .status-bar {
            position: absolute; top: 10px; width: 100%;
            text-align: center; font-size: 1.2rem;
            text-shadow: 0 0 5px #00f3ff;
            background: rgba(0,0,0,0.5);
            padding: 5px 0;
        }

        /* Large Central Feedback Text */
        #main-feedback {
            position: absolute;
            bottom: 20%;
            width: 100%;
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }

        /* Controls Area (Bottom of Phone) */
        .controls {
            height: 25vh;
            width: 100%;
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: #050505;
            padding: 10px;
        }

        button {
            width: 45%;
            height: 60px;
            background: transparent;
            border: 2px solid #00f3ff;
            color: #00f3ff;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.2rem;
            border-radius: 10px;
        }
        button.active { background: #00f3ff; color: #000; box-shadow: 0 0 15px #00f3ff; }

        /* Loader */
        #loader {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.8);
            padding: 20px; border: 1px solid #00f3ff;
            z-index: 99;
        }
    </style>
</head>
<body>

    <div id="interface-container">
        <div id="loader">LOADING AI...</div>
        <div id="canvas-wrapper"></div>
        
        <div class="hud-overlay">
            <div class="status-bar" id="status-text">INITIALIZING...</div>
            <div id="main-feedback"></div>
        </div>
    </div>

    <div class="controls">
        <button id="btn-bat" class="active" onclick="setMode('batting')">BAT</button>
        <button id="btn-bowl" onclick="setMode('bowling')">BOWL</button>
    </div>

    <script>
        let video;
        let poseNet;
        let poses = [];
        let mode = 'batting';
        let feedbackEl = document.getElementById('main-feedback');

        function setup() {
            // Make canvas fill the container
            let container = document.getElementById('interface-container');
            let w = container.offsetWidth;
            let h = container.offsetHeight;
            let canvas = createCanvas(w, h);
            canvas.parent('canvas-wrapper');

            // --- MOBILE CAMERA SETUP ---
            // We specifically ask for the "user" (front) camera
            // and audio: false to avoid permission errors
            let constraints = {
                video: {
                    facingMode: "user"
                },
                audio: false
            };
            
            video = createCapture(constraints, function(stream) {
                // IMPORTANT FOR IPHONE:
                // Prevents the video from going full screen automatically
                video.elt.setAttribute('playsinline', '');
            });
            
            video.size(w, h);
            video.hide();

            // Load Fast AI
            let options = {
                architecture: 'MobileNetV1',
                imageScaleFactor: 0.3,
                outputStride: 16,
                flipHorizontal: true, // Mirror mode for selfie camera
                minConfidence: 0.5,
                detectionType: 'single',
                multiplier: 0.50 
            };

            poseNet = ml5.poseNet(video, options, modelReady);
            poseNet.on('pose', function(results) { poses = results; });
        }

        function modelReady() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('status-text').innerText = "CAMERA ACTIVE";
        }

        function draw() {
            // Draw video to fill screen
            image(video, 0, 0, width, height);
            
            // Darken slightly for UI pop
            fill(0, 40);
            rect(0,0,width,height);

            drawSkeleton();
            analyze();
        }

        function analyze() {
            if (poses.length > 0) {
                let p = poses[0].pose;
                if (p.score < 0.2) return;

                if (mode === 'batting') {
                    // Simple Stance Check
                    let kneeY = (p.leftKnee.y + p.rightKnee.y) / 2;
                    let hipY = (p.leftHip.y + p.rightHip.y) / 2;
                    let diff = kneeY - hipY;

                    // On mobile, pixels are smaller, so we adjust threshold
                    if (diff > 100) { 
                        feedbackEl.innerText = "GOOD STANCE";
                        feedbackEl.style.color = "#0f0";
                    } else {
                        feedbackEl.innerText = "BEND KNEES";
                        feedbackEl.style.color = "red";
                    }
                } else {
                    // Bowling Logic
                    if (p.rightWrist.y < p.nose.y) {
                        feedbackEl.innerText = "HIGH ARM!";
                        feedbackEl.style.color = "#0f0";
                    } else {
                        feedbackEl.innerText = "LIFT ARM";
                        feedbackEl.style.color = "red";
                    }
                }
            }
        }

        function drawSkeleton() {
            if (poses.length > 0) {
                let p = poses[0].pose;
                stroke(0, 243, 255);
                strokeWeight(3);
                
                // Draw simple stick figure
                let points = [p.leftShoulder, p.rightShoulder, p.leftHip, p.rightHip, p.leftKnee, p.rightKnee];
                for (let pt of points) {
                    if(pt.score > 0.5) ellipse(pt.x, pt.y, 10, 10);
                }
            }
        }
        
        // Handle resizing (rotating phone)
        function windowResized() {
            let container = document.getElementById('interface-container');
            resizeCanvas(container.offsetWidth, container.offsetHeight);
            video.size(container.offsetWidth, container.offsetHeight);
        }

        function setMode(m) {
            mode = m;
            document.getElementById('btn-bat').className = (m==='batting'?'active':'');
            document.getElementById('btn-bowl').className = (m==='bowling'?'active':'');
        }
    </script>
</body>
</html>
